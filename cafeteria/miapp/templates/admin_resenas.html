{% extends 'base.html' %}

{% block title %}Administrar Reseñas - Cafeteria{% endblock %}
{% block content %}
<script>
   function abrirModalEliminar(id, nombre) {
        $('#eliminarID').val(id);
        $('#elminarNombre').text('¿Desea eliminar la reseña de ' + nombre + '?');
        $('#eliminarResenaModal').modal('show');
      }
</script>
<div class="container mt-4">
  <h1>Administrar Reseñas</h1>
  <!-- Formulario de búsqueda -->
  <form method="get" class="mb-4">
    <div class="input-group">
      <input
        type="text"
        name="q"
        class="form-control"
        placeholder="Buscar por nombre o descripción..."
        value="{{ search_query }}"
      >
      <button type="submit" class="btn btn-primary">
        <i class="bi bi-search"></i> Buscar
      </button>
      <a href="{% url 'resena_admin' %}" class="btn btn-secondary">
        <i class="bi bi-x-lg"></i> Limpiar
      </a>
    </div>
  </form>

  <!-- Botón para agregar café -->
  <button
    type="button"
    class="btn btn-success mb-3"
    data-bs-toggle="modal"
    data-bs-target="#resenasModal"
  >
    <i class="bi bi-plus-lg"></i> Agregar Resena
  </button>

 <table class="table table-striped">
    <thead>
      <tr>
        <th>Nombre Cliente</th>
        <th>comentario</th>
        <th>Calificacion</th>
        <th>Fecha de creacion</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for resena in resenas %}
        <tr>
          <td>{{ resena.nombre_cliente }}</td>
          <td>{{ resena.comentario }}</td>
          <td>{{ resena.calificacion }}</td>
          <td>
            <a
              href="{% url 'resena_admin' resena.id %}"
              class="btn btn-warning btn-sm"
              style="display: inline;"

            > Editar
            </a>
            </td>
            <td>
              <button
                type="button"
                class="btn btn-danger btn-sm inline"
                onclick="abrirModalEliminar({{ resena.id }} , '{{ resena.nombre_cliente }}')"
              > Eliminar
              </button>
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="5">No se encontraron resenas{% if search_query %} para "{{ search_query }}"{% endif %}.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if resenas.paginator.num_pages > 1 %}
  <nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
      {% if resenas.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?q={{ search_query }}&page=1">&laquo; Primera</a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?q={{ search_query }}&page={{ resenas.previous_page_number }}">Anterior</a>
        </li>
      {% endif %}
      <li class="page-item disabled">
        <span class="page-link">
          Página {{ resenas.number }} de {{ resenas.paginator.num_pages }}
        </span>
      </li>
      {% if resenas.has_next %}
        <li class="page-item">
          <a class="page-link" href="?q={{ search_query }}&page={{ resenas.next_page_number }}">Siguiente</a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?q={{ search_query }}&page={{ resenas.paginator.num_pages }}">Última &raquo;</a>
        </li>
      {% endif %}
    </ul>
  </nav>
{% endif %}

  <!-- Modal para crear/editar -->
  <div class="modal fade" id="resenasModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="action" value="{% if resena %}update{% else %}create{% endif %}">
          {% if resena %}
            <input type="hidden" name="id" value="{{ resena.id }}">
          {% endif %}
          <div class="modal-header">
            <h5 class="modal-title">
              {% if resena %}Editar{% else %}Crear{% endif %} Reseña
            </h5>
            <button type="button" class="close" data-bs-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body">
            {{ form.as_p }}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary">
              Guardar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- modal para confirmar eliminación  -->
  <div class="modal fade" id="eliminarResenaModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="action" value="delete">
          <input id="eliminarID" type="hidden" name="id" value="">
          <div class="modal-header">
            <h5 class="modal-title">Eliminar Reseña</h5>
            <button type="button" class="close" data-bs-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div id="elminarNombre" class="modal-body">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Cancelar
            </button>
            <button type="submit" class="btn btn-danger">
              Eliminar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Mensajes de éxito/error -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

<!-- Script para abrir el modal al cargar la página (si hay un ID en la URL) -->
{% if resena %}
  <script>
    $(document).ready(function() {
      $('#resenasModal').modal('show');
      $('#resenasModal').on('hidden.bs.modal', function () {
        window.location.href = '{% url "renas_admin" %}';
      });
    });
  </script>
{% endif %}
{% endblock %}