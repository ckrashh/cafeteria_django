{% extends "base.html" %}
{% load static %}
{% block title %}Admin de Usuarios - Aroma Celestial {% endblock %}
{% block content %}
<h1>Lista de Usuarios</h1>
  <!-- Formulario de búsqueda -->
  <form method="get" class="mb-4">
    <div class="input-group">
      <input
        type="text"
        name="q"
        class="form-control"
        placeholder="Buscar por nombre de usuario, primero nombre, apellido o correo..."
        value="{{ search_query }}"
      >
      <button type="submit" class="btn btn-primary">
        <i class="bi bi-search"></i> Buscar
      </button>
      <a href="{% url 'admin_usuarios' %}" class="btn btn-secondary">
        <i class="bi bi-x-lg"></i> Limpiar
      </a>
    </div>
  </form>
<div class="table-responsive">
  <table class="table table-striped table-bordered align-middle">
    <thead class="table-dark">
      <tr>
        <th scope="col" class="text-center">Username</th>
        <th scope="col">Nombre</th>
        <!-- Apellido oculto en móviles -->
        <th scope="col" class="d-none d-md-table-cell">Apellido</th>
        <!-- Email oculto en móviles -->
        <th scope="col" class="d-none d-lg-table-cell">Email</th>
        <th scope="col" class="text-center">Grupos</th>
        <th scope="col" class="text-center">Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for usuario in usuarios %}
        <tr>
          <!-- Username siempre visible -->
          <td class="text-center">{{ usuario.username }}</td>
          <!-- Nombre siempre visible -->
          <td>{{ usuario.first_name }}</td>
          <!-- Apellido oculto en móviles -->
          <td class="d-none d-md-table-cell">{{ usuario.last_name }}</td>
          <!-- Email oculto en móviles -->
          <td class="d-none d-lg-table-cell">{{ usuario.email|truncatechars:20 }}</td>
          <!-- Grupos - siempre visible pero condensado -->
          <td class="text-center">
            {% for grupo in usuario.groups.all %}
              <span class="badge bg-secondary">{{ grupo.name }}</span>
              {% if not forloop.last %}<br class="d-md-none">{% endif %}
            {% endfor %}
          </td>
          <!-- Acciones - botones apilados en móviles -->
          <td class="text-center">
            <div class="d-flex flex-column flex-md-row gap-2 justify-content-center">
              <!-- Cambiar grupo - botón pequeño -->
              <form method="post" class="m-0">
                {% csrf_token %}
                <input type="hidden" name="usuario_id" value="{{ usuario.id }}">
                <input type="hidden" name="action" value="editar_grupo">
                <div class="input-group input-group-sm">
                  {{ cambiar_grupo_form.grupo }}
                  <button type="submit" class="btn btn-primary btn-sm">
                    <i class="bi bi-people"></i>
                    <span class="d-none d-sm-inline">Cambiar</span>
                  </button>
                </div>
              </form>

              <!-- Eliminar - botón con icono -->
              <form method="post" class="m-0">
                {% csrf_token %}
                <input type="hidden" name="usuario_id" value="{{ usuario.id }}">
                <input type="hidden" name="action" value="eliminar">
                <button type="submit" class="btn btn-danger btn-sm"
                        onclick="return confirm('¿Eliminar a {{ usuario.username }}?')">
                  <i class="bi bi-trash"></i>
                  <span class="d-none d-sm-inline">Eliminar</span>
                </button>
              </form>

              <!-- Editar - botón que abre modal -->
              <button class="btn btn-warning btn-sm"
                      data-bs-toggle="modal"
                      data-bs-target="#editarUsuarioModal{{ usuario.id }}">
                <i class="bi bi-pencil-square"></i>
                <span class="d-none d-sm-inline">Editar</span>
              </button>
            </div>
          </td>
        </tr>

        <!-- Modal para editar usuario (fuera del tr para mejor organización) -->
        <div class="modal fade" id="editarUsuarioModal{{ usuario.id }}" tabindex="-1" aria-labelledby="editarUsuarioModalLabel{{ usuario.id }}" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="usuario_id" value="{{ usuario.id }}">
                <input type="hidden" name="action" value="editar">
                <div class="modal-header">
                  <h5 class="modal-title" id="editarUsuarioModalLabel{{ usuario.id }}">Editar Usuario</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-3">
                    <label for="first_name{{ usuario.id }}" class="form-label">Nombre</label>
                    <input type="text" class="form-control" id="first_name{{ usuario.id }}" name="first_name" value="{{ usuario.first_name }}" required>
                  </div>
                  <div class="mb-3">
                    <label for="last_name{{ usuario.id }}" class="form-label">Apellido</label>
                    <input type="text" class="form-control" id="last_name{{ usuario.id }}" name="last_name" value="{{ usuario.last_name }}" required>
                  </div>
                  <div class="mb-3">
                    <label for="email{{ usuario.id }}" class="form-label">Correo Electrónico</label>
                    <input type="email" class="form-control" id="email{{ usuario.id }}" name="email" value="{{ usuario.email }}" required>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                  <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      {% empty %}
        <tr>
          <td colspan="6" class="text-center">
            No se encontraron usuarios{% if search_query %} para "{{ search_query }}"{% endif %}.
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% if is_paginated %}
  <div class="pagination">
    <span class="step-links">
      {% if page_obj.has_previous %}
        <a href="?page=1">&laquo; primera</a>
        <a href="?page={{ page_obj.previous_page_number }}">anterior</a>
      {% endif %}

      <span class="current">
        Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}.
      </span>

      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}">siguiente</a>
        <a href="?page={{ page_obj.paginator.num_pages }}">última &raquo;</a>
      {% endif %}
    </span>
  </div>
{% endif %}
<!-- Mensajes de éxito/error -->
{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">
      {{ message }}
    </div>
  {% endfor %}
{% endif %}
{% endblock %}